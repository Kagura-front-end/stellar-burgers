import { FC, useEffect } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { useAppDispatch, useAppSelector } from '../../services/store';
import { OrdersList } from '../../components/orders-list/orders-list';
import { Preloader } from '@ui';

import { fetchIngredients } from '../../services/ingredients/ingredients.slice';
import {
  fetchUserOrders,
  selectUserOrders,
  selectUserOrdersLoading,
  selectUserOrdersError,
  userOrdersActions,
} from '../../services/orders/userOrders.slice';

export const ProfileOrders: FC = () => {
  const dispatch = useAppDispatch();
  const location = useLocation();
  const navigate = useNavigate();

  const orders = useAppSelector(selectUserOrders);
  const loading = useAppSelector(selectUserOrdersLoading);
  const error = useAppSelector(selectUserOrdersError);

  // Load once on mount
  useEffect(() => {
    dispatch(userOrdersActions.clear());
    // Ensure ingredients and orders exist just like canonical
    void Promise.all([dispatch(fetchIngredients()), dispatch(fetchUserOrders())]);
  }, [dispatch]);

  const openOrder = (n: number | string) =>
    navigate(`/profile/orders/${n}`, { state: { background: location } });

  if (loading) return <Preloader />;

  if (error)
    return (
      <p className='text text_type_main-default' style={{ padding: 24 }}>
        Ошибка загрузки заказов: {error}
      </p>
    );

  if (!orders || orders.length === 0)
    return (
      <p className='text text_type_main-default' style={{ padding: 24 }}>
        Заказов пока нет.
      </p>
    );

  return <OrdersList orders={orders} onClick={openOrder} />;
};
